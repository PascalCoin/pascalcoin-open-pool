<!-- Worker Statistics -->

<div id="accountSearch2" class="input-group">
  <input class="form-control" type="text" tplaceholder="enterYourAccount" placeholder="Search Account">
  <div class="input-group-append">
    <button class="btn btn-secondary" type="button" id="lookUp">Search</button>
  </div>
</div>

<div id="addressError" class="my-3"></div>


<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h4 class="modal-title">User Settings</h4>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <div>
          <p>To change your account settings, you must specify your password (the email portion of your login) and either the minimum payout field, the public key field, or both.</p>
          <p>For security purposes, you must use the same email / password for all of your workers. This prevents someone from mining to your account with their email for a short period of time in order to change your settings.</p>
          <p>If you are receiving an "incorrect password" message, make sure that all your workers have the same email / password. If you recently changed your password, allow <span id="passwordExpireTime">1 hour</span> for your old password to expire.</p>
          <p>You can receive 1 PASA for every <span class="pasaThreshold">10 PASC</span> you mine on this pool. You must use a secp256k1 key. To get your public key from the wallet, go to Project &gt; Private Keys and copy the public key in base58 format.<p>
            <hr/>
            <div>
              <strong>Your current minimum payout is:</strong> <span id="myCurrentMinPayout"></span>
              <br/>
              <strong>Your current public key is:</strong> <code style="word-break: break-all" id="myCurrentPublicKey"></code>
              <br/>
              <span class="emailEnabled">
                <strong>Your current notification settings are:</strong> <span id="myCurrentNotifySettings"></span>
              </span>
            </div>
            <hr/>
          <p>Update settings:</p>
        </div>

        <form id="userSettings" class="form-row mt-3">

          <div class="form-group col-12">
            <div class="input-group">
              <div class="input-group-prepend">
                <div class="input-group-text" style="width:42px">
                  <i class="fa fa-at"></i>
                </div>
              </div>
              <input class="form-control" type="text" name="email" tplaceholder="emailPassword" placeholder="Email / Password" required="required" />
            </div>
          </div>

          <div class="form-group col-12">
            <div class="input-group">
              <div class="input-group-prepend">
                <div class="input-group-text" style="width:42px">
                  <i class="fa fa-bank"></i>
                </div>
              </div>
              <input class="form-control" type="text" name="minPayout" tplaceholder="minPayout" placeholder="Minimum Payout" />
            </div>
          </div>

          <div class="form-group col-12">
            <div class="input-group">
              <div class="input-group-prepend">
                <div class="input-group-text" style="width:42px">
                  <i class="fa fa-key"></i>
                </div>
              </div>
              <input class="form-control" type="text" name="publicKey" tplaceholder="publicKey" placeholder="Public Key" />
            </div>
          </div>

          <div class="form-group col-12 emailEnabled">
            <div class="form-check form-check-inline">
              <span>Notify me when:</span>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="notify1" name="notify[]" value="worker_start">
              <label class="form-check-label" for="notify1">Worker starts hashing</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="notify2" name="notify[]" value="worker_stop">
              <label class="form-check-label" for="notify2">Worker stops hashing</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="notify3" name="notify[]" value="payment_pasc">
              <label class="form-check-label" for="notify3">PASC payment is made</label>
            </div>
            <div class="form-check form-check-inline">
              <input class="form-check-input" type="checkbox" id="notify4" name="notify[]" value="payment_pasa">
              <label class="form-check-label" for="notify4">PASA payment is made</label>
            </div>
          </div>

          <input type="hidden" name="account" value="" />
        </form>
      </div>
      <div class="modal-footer">
        <span id="settingsMessage"></span>
        <button type="button" class="btn btn-light" data-dismiss="modal">Close</button>
        <button type="button" class="btn btn-secondary" id="saveSettings">Save changes</button>
      </div>
    </div>
  </div>
</div>

<div id="workerStats" class="row" style="display:none">

  <div class="col-12">
    <h4 id="accountLabel" class="text-center my-4">
      <span tkey="account">Account</span>: <span id="yourStatsInput"></span>
      <span id="hasPaymentId">
        <span tkey="paymentId">Payment ID</span>: <span id="yourPaymentId"></span>
      </span>
      <div class="accountLabelButtons">
	<button type="button" class="btn btn-sm btn-secondary ml-3" data-toggle="modal" data-target="#settingsModal">
          Settings
	</button>
	<button id="watchAccount" type="button" class="btn btn-sm btn-secondary ml-1" data-account="" data-op="watch">
          Watch
	</button>
      </div>
    </h4>
    <div id="accountMessages"></div>
  </div>

  <!-- Current Hash Rate -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <span class="fa fa-dashboard"></span>
      </div>
      <div class="content">
        <div class="text"><span tkey="currentHashRate">Current Hash Rate</span></div>
        <div class="value"><span id="yourHashrateHolder">N/A</span></div>
      </div>
    </div>
  </div>

  <!-- Avg Hash Rate -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <span class="fa fa-dashboard"></span>
      </div>
      <div class="content">
        <div class="text"><span tkey="averageHashRate1">Average 1-hour Hash Rate</span></div>
        <div class="value">
          <span id="yourHR1h"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Avg Hash Rate -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <span class="fa fa-dashboard"></span>
      </div>
      <div class="content">
        <div class="text"><span tkey="averageHashRate6">Average 6-hour Hash Rate</span></div>
        <div class="value">
          <span id="yourHR6h"></span>
        </div>
      </div>
    </div>
  </div>

  <!-- Avg Hash Rate -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <span class="fa fa-dashboard"></span>
      </div>
      <div class="content">
        <div class="text"><span tkey="averageHashRate24">Average 24-hour Hash Rate</span></div>
        <div class="value">
          <span id="yourHR24h"></span>
        </div>
      </div>
    </div>
  </div>


  <!-- Balance -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <i class="fa fa-bank"></i>
      </div>
      <div class="content">
        <div class="text"><span tkey="balance">Balance</span></div>
        <div class="value"><span id="yourPendingBalance"></span></div>
      </div>
    </div>
  </div>

  <!-- Unconfirmed Balance -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <i class="fa fa-bank"></i>
      </div>
      <div class="content">
        <div class="text"><span tkey="unconfirmedBalance">Unconfirmed Balance</span></div>
        <div class="value"><span id="yourUnconfirmed"></span></div>
      </div>
    </div>
  </div>

  <!-- Total Paid -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <i class="fa fa-money"></i>
      </div>
      <div class="content">
        <div class="text"><span tkey="totalPaid">Total Paid</span></div>
        <div class="value"><span id="yourPaid"></span></div>
      </div>
    </div>
  </div>

  <!-- Total Paid -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <i class="fa fa-bank"></i>
      </div>
      <div class="content">
        <div class="text"><span tkey="totalPasa">Total PASA Paid</span></div>
        <div class="value"><span id="yourPasa"></span></div>
      </div>
    </div>
  </div>


  <!-- Total Hashes -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <i class="fa fa-cloud-upload"></i>
      </div>
      <div class="content">
        <div class="text"><span tkey="totalHashes">Total Hashes Submitted</span></div>
        <div class="value"><span id="yourHashes"></span></div>
      </div>
    </div>
  </div>

  <!-- Last Hash -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <i class="fa fa-clock-o"></i>
      </div>
      <div class="content">
        <div class="text"><span tkey="lastHash">Last Hash Submitted</span></div>
        <div class="value"><span id="yourLastShare"></span></div>
      </div>
    </div>
  </div>

  <!-- Round Contribution -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <i class="fa fa-pie-chart"></i>
      </div>
      <div class="content">
        <div class="text"><span tkey="roundContribution">Round Contribution</span></div>
        <div class="value"><span id="yourRoundContribution">N/A</span></div>
      </div>
    </div>
  </div>

  <!-- Invalid Share Pct -->
  <div class="col-lg-3 col-sm-4">
    <div class="infoBox">
      <div class="icon">
        <i class="fa fa-exclamation-triangle"></i>
      </div>
      <div class="content">
        <div class="text"><span tkey="invalidSharePct">Invalid Share Percent</span></div>
        <div class="value"><span id="yourInvalidPct"></span></div>
      </div>
    </div>
  </div>

  <div class="col-12 userChart">
    <h4 class="text-center"><span tkey="hashrateWeek">Hashrate (last 7 days)</span></h4>
    <div class="chart">
      <canvas height="100" id="chart_hashrate"></canvas>
    </div>
  </div>

  <div class="col-sm-6 userChart">
    <h4 class="text-center"><span tkey="hashesPerHour">Hashes per hour (last 24 hours)</span></h4>
    <div class="chart">
      <canvas height="100" id="chart_hashes"></canvas>
    </div>
  </div>

  <div class="col-sm-6 userChart">
    <h4 class="text-center"><span tkey="latestPayments">Latest payments</span></h4>
    <div class="chart">
      <canvas height="100" id="chart_payments"></canvas>
    </div>
  </div>


  <div class="col-12">

    <ul class="nav nav-tabs" id="workerTabs" role="tablist">
      <li class="nav-item">
        <a class="nav-link active" id="worker-tab" data-toggle="tab" href="#workers" role="tab" aria-controls="workers" aria-selected="true">Workers</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="payment-tab" data-toggle="tab" href="#payments" role="tab" aria-controls="payments" aria-selected="false">Payments</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="pasaPayment-tab" data-toggle="tab" href="#pasaPayments" role="tab" aria-controls="pasaPayments" aria-selected="false">Accounts</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" id="shares-tab" data-toggle="tab" href="#shares" role="tab" aria-controls="shares" aria-selected="false">Shares</a>
      </li>
    </ul>

    <div class="tab-content" id="workerTabsContent">

      <!-- Workers -->
      <div class="tab-pane fade show active" id="workers" role="tabpanel" aria-labelledby="worker-tab">
        <div id="workersReport" class="table-responsive">
          <table class="table table-hover table-striped">
            <thead>
              <tr>
                <th class="col1 sort"><span tkey="status">Status</span> <i class="fa fa-sort"></i></th>
                <th class="col2 sort"><span tkey="workerName">Worker Name</span> <i class="fa fa-sort"></i></th>
                <th class="col3 sort"><span tkey="hashRate">Hash Rate</span> <i class="fa fa-sort"></i></th>
                <th class="col4 sort avghr" title="Average hashrate over the last hour (only includes times the worker was active)"><span tkey="hashRate1h">HR (1h)</span> <i class="fa fa-sort"></i></th>
                <th class="col5 sort avghr" title="Average hashrate over the last six hours (only includes times the worker was active)"><span tkey="hashRate6h">HR (6h)</span> <i class="fa fa-sort"></i></th>
                <th class="col6 sort avghr" title="Average hashrate over the last day (only includes times the worker was active)"><span tkey="hashRate24h">HR (24h)</span> <i class="fa fa-sort"></i></th>
                <th class="col7 sort"><span tkey="lastShare">Last Share Submitted</span> <i class="fa fa-sort"></i></th>
                <th class="col8 sort"><span tkey="totalHashes">Total Hashes Submitted</span> <i class="fa fa-sort"></i></th>
              </tr>
            </thead>
            <tbody id="workersReport_rows">

            </tbody>
          </table>
        </div>
      </div>
      <!-- /Workers -->

      <!-- Payments -->
      <div class="tab-pane fade" id="payments" role="tabpanel" aria-labelledby="payment-tab">
        <div id="workerPayments" class="table-responsive">
          <table class="table table-hover table-striped">
            <thead>
              <tr>
                <th class="col1"><span tkey="timeSent">Time Sent</span></th>
                <th class="col2"><span tkey="operationHash">Operation Hash</span></th>
                <th class="col3"><span tkey="amount">Amount</span></th>
                <th class="col4"><span tkey="fee">Fee</span></th>
              </tr>
            </thead>
            <tbody id="paymentsReport_rows">

            </tbody>
          </table>
        </div>
        <p class="text-center">
          <button type="button" class="btn btn-secondary mt-3" id="loadMorePayments">
            <span tkey="loadMore">Load More</span>
          </button>
        </p>
      </div>
      <!-- /Payments -->

      <!-- PasaPayments -->
      <div class="tab-pane fade" id="pasaPayments" role="tabpanel" aria-labelledby="pasaPayment-tab">
        <div id="workerPasaPayments" class="table-responsive">
          <table class="table table-hover table-striped">
            <thead>
              <tr>
                <th class="col1"><span tkey="timeSent">Time Sent</span></th>
                <th class="col2"><span tkey="operationHash">Operation Hash</span></th>
                <th class="col3"><span tkey="account">Account</span></th>
                <th class="col4"><span tkey="fee">Fee</span></th>
              </tr>
            </thead>
            <tbody id="pasaPaymentsReport_rows">

            </tbody>
          </table>
        </div>
        <p class="text-center">
          <button type="button" class="btn btn-secondary mt-3" id="loadMorePasaPayments">
            <span tkey="loadMore">Load More</span>
          </button>
        </p>
      </div>
      <!-- /PasaPayments -->

      <!-- Shares -->
      <div class="tab-pane fade" id="shares" role="tabpanel" aria-labelledby="shares-tab">
        <div id="workerShares" class="table-responsive">
          <table class="table table-hover table-striped">
            <thead>
              <tr>
                <th class="col1"><span tkey="date">Date</span></th>
                <th class="col2"><span tkey="hashes">Hashes</span></th>
                <th class="col3"><span tkey="shares">Valid Shares</span></th>
                <th class="col4"><span tkey="shares">Invalid Shares</span></th>
              </tr>
            </thead>
            <tbody id="sharesReport_rows">

            </tbody>
          </table>
        </div>
      </div>
      <!-- /Shares -->

    </div>
  </div>
</div>


<!-- Javascript -->
<script>
// Charts
var userChartsData = null;
var chartsInitialized = false;
var intervalChartsUpdate;
var chartsObj = {};

// Update current page
currentPage = {
    destroy: function() {
        $("#yourLastShare").timeago("dispose");
        if(xhrAddressPoll) xhrAddressPoll.abort();
        if(addressTimeout) clearTimeout(addressTimeout);
        if(xhrGetPayments) xhrGetPayments.abort();
        if(chartsInitialized) {
            chartsInitialized = false;
            clearInterval(intervalChartsUpdate);
            Object.keys(chartsObj).forEach(function(graphType) {
                if(chartsObj.hasOwnProperty(graphType) && chartsObj[graphType] != null) {
                    chartsObj[graphType].destroy();
                }
            });
        }
    },
    update: function() {}
};

function getCurrentAccount() {
    return window.location.hash.split("account/")[1] || getMyAccount();
}


/**
 * Miner statistics
 **/
// Load current miner statistics
var xhrAddressPoll;
var addressTimeout;

function fetchAddressStats(longpoll) {
    var address = getCurrentAccount();

    xhrAddressPoll = $.ajax({
        url: api + "/stats_address",
        data: {
            address: address,
            longpoll: longpoll
        },
        dataType: "json",
        cache: "false",
        success: function(data) {
            if(!data.stats) {
                $("#workerStats").hide();
                $("#addressError").text(data.error).show();
                return;
            }

            $("#workerStats").show();
            $("#addressError").hide();

            $("#yourStatsInput").html(formatExternalAccountLink(data.account.address, data.account.known_account));
            if(data.account.payment_id == "0") {
                $("#hasPaymentId").hide();
            } else {
                $("#hasPaymentId").show();
            }
            updateText("yourPaymentId", data.account.payment_id);

            $("#watchAccount").attr("data-account", data.account.address_pid);

            if(getMyAccount() == data.account.address_pid) {
                $("#watchAccount").attr("data-op", "unwatch");
                $("#watchAccount").html("Unwatch");
            } else {
                $("#watchAccount").attr("data-op", "watch");
                $("#watchAccount").html("Watch");
            }

            if(data.stats.lastShare) {
                $("#yourLastShare").timeago("update", new Date(parseInt(data.stats.lastShare) * 1000).toISOString());
            } else {
                updateText("yourLastShare", "Never");
            }

            updateText("yourHashrateHolder", (getReadableHashRateString(data.stats.hashrate) || "0 H") + "/s");
            if("hashrate_1h" in data.stats) {
                $("#minerAvgHR").show();
                updateText("yourHR1h", (getReadableHashRateString(data.stats.hashrate_1h) || "0 H") + "/s");
                updateText("yourHR6h", (getReadableHashRateString(data.stats.hashrate_6h) || "0 H") + "/s");
                updateText("yourHR24h", (getReadableHashRateString(data.stats.hashrate_24h) || "0 H") + "/s");
            } else {
                $("#minerAvgHR").hide();
            }
            updateText("yourHashes", (data.stats.hashes || 0).toString());
            updateText("yourPaid", getReadableCoins(data.stats.paid, true));
            updateText("yourPasa", (data.stats.pasaPaid || 0)+" PASA");
            updateText("yourPendingBalance", getReadableCoins(data.stats.balance, true));
            updateText("yourUnconfirmed", getReadableCoins(data.stats.lockedBalance, true));

            var userRoundHashes = parseInt(data.stats.roundHashes || 0);
            var poolRoundHashes = parseInt(lastStats.pool.roundHashes || 0);
            var share_pct = poolRoundHashes == 0 ? 0 : Math.min(100, userRoundHashes * 100 / poolRoundHashes);

            updateText("yourRoundContribution", (Math.round(share_pct * 1000) / 1000)+"%");

	    var s = data.charts.shares;
	    if(s && s.length >= 2) {
		var invalidShares_2h = (s[s.length-1][3]||0)+(s[s.length-2][3]||0);
		var totalShares_2h = invalidShares_2h + (s[s.length-1][2]||0)+(s[s.length-2][2]||0);
		var invalidShare_pct = 100 * invalidShares_2h / totalShares_2h;

		if(invalidShare_pct > 10 && $("#accountMessages .alert-shares").length === 0) {
                    $("#accountMessages").append('<div class="alert alert-danger alert-shares">High percentage of invalid shares detected; please check your workers!</div>');
		} else if(invalidShare_pct <= 10  && $("#accountMessages .alert-shares").length === 1) {
		    $("#accountMessages .alert-shares").remove();
		}
		updateText("yourInvalidPct", (Math.round(invalidShare_pct * 1000) / 1000)+"%");
	    }


            renderPayments(data.payments);
            renderPasaPayments(data.pasaPayments);
            renderShares(data.charts.shares);

            if(data.workers && data.workers.length > 0) {
                renderWorkers(data.workers);
                $(".yourWorkers").show();
            }

            $(".yourStats").show();

            if(data.charts) {
                userChartsData = data.charts;
                if(!chartsInitialized) {
                    intervalChartsUpdate = setInterval(createCharts, 60*1000);
                    createCharts();
                    chartsInitialized = true;
                }
            }

            fetchAddressStats(true);
        },
        error: function(e) {
            if(e.statusText === "abort") return;
            $("#addressError").text("Connection error").show();

            if(addressTimeout) clearTimeout(addressTimeout);
            addressTimeout = setTimeout(function() {
                fetchAddressStats(false);
            }, 2000);
        }
    });
}

function fetchAddressSettings() {
    var address = getCurrentAccount();
    $.ajax({
        url: api + "/get_miner_settings",
        data: {
            account: address,
        },
        dataType: "json",
        cache: "false",
        success: function(data) {

            if(data.publicKey === false && $("#accountMessages .alert-pubkey").length === 0) {
                $("#accountMessages").append('<div class="alert alert-danger alert-pubkey">Public key for PASA payments has not been set; unclaimed PASA will be donated!</div>');
            }

            updateText("myCurrentMinPayout", getReadableCoins(data.minPayout));
            updateText("myCurrentPublicKey", data.publicKey ? data.publicKey : "None");

            if(data.notify) {
                var notifyHuman = [];
                var notify = data.notify.split(",");
                jQuery("input[name='notify[]']").prop("checked", false);
                for(var i = 0; i < notify.length; i++) {
                    var checkbox = $("input[value='"+notify[i]+"']");
                    var label = $("label[for='"+checkbox.attr("id")+"']").html().trim();
                    checkbox.prop("checked", true);
                    notifyHuman.push(label);
                }
                updateText("myCurrentNotifySettings", notifyHuman.join(", "));
            } else {
                updateText("myCurrentNotifySettings", "None")
            }

            updateTextClasses("pasaThreshold", lastStats.config.pasaThreshold + " " + lastStats.config.symbol);
            updateText("passwordExpireTime", getReadableTime(lastStats.config.passwordExpireTime || 3600));
            if(lastStats.config.sendEmails) {
                $(".emailEnabled").show();
            } else {
                $(".emailEnabled").hide();
            }
        },
        error: function(e) {
        }
    });

}

// Click on lookup button
$("#lookUp").click(function() {
    var address = $("#accountSearch2 input").val().trim();

    loadLiveStats(true);

    $("#addressError, .yourStats, .yourWorkers, .userChart").hide();
    $("#workersReport_rows").empty();
    $("#paymentsReport_rows").empty();

    $("#lookUp > span:first-child").hide();
    $("#lookUp > span:last-child").show();

    if(xhrAddressPoll) xhrAddressPoll.abort();
    if(addressTimeout) clearTimeout(addressTimeout);

    $("#lookUp > span:last-child").hide();
    $("#lookUp > span:first-child").show();

    if(!address) {
        $("#yourStatsInput").focus();
        return;
    }

    fetchAddressStats(false);

    fetchAddressSettings();
});

// Lookup if current account is known
var address = getCurrentAccount();
if(address) {
    $("#settingsModal input[name=\"account\"]").val(address);
    $("#accountSearch2 input").val(address);
    $("#accountSearch2 button").click();
}

$("#accountSearch2 button").click(function() {
    var account = $("#accountSearch2 input").val();
    var loc = "#account";
    if(account) loc += "/"+account;
    window.location.hash = loc;
});
$("#accountSearch2 input").keyup(function(e) {
    if(e.keyCode === 13)
        $("#accountSearch2 button").click();
});


$("#watchAccount").click(function() {
    var watchOp = $("#watchAccount").attr("data-op");
    if(watchOp == "unwatch") {
        var watchAccount = "";
        $("#watchAccount").attr("data-op", "watch");
        $("#watchAccount").html("Watch");
    } else {
        var watchAccount = $("#watchAccount").attr("data-account");
        $("#watchAccount").attr("data-op", "unwatch");
        $("#watchAccount").html("Unwatch");
    }
    docCookies.setItem("mining_account", watchAccount, Infinity);
    loadLiveStats(true);
});



/**
 * Charts
 **/

// Create charts
function createCharts() {
    if(!userChartsData) return ;
    var data = userChartsData;

    var graphData = {
        hashrate: getGraphData(data.hashrate),
        payments: getGraphData(data.payments, true),
        hashes: getGraphData(data.shares)
    };

    for (var graphType in graphData) {
        if(graphData[graphType].values.length > 1) {
            var $chart = $("#chart_"+graphType);

            var bgcolor = "#f8a84d";
            var bordercolor = "#c47b22";
            var borderwidth = 1;

            if($chart.length === 0) continue;

            var ctx = $chart.get(0).getContext("2d");
            var chartConfig = {
                type: "line",
                data: {
                    labels: graphData[graphType].names,
                    datasets: [{
                        data: graphData[graphType].values,
                        dataType: graphType,
                        fill: true,
                        backgroundColor: bgcolor,
                        borderColor: bordercolor,
                        borderWidth: borderwidth
                    }]
                },
                options: {
                    animation: false,
                    responsive: true,
                    maintainAspectRatio: true,
                    legend: { display: false },
                    elements: { point: { radius: 0, hitRadius: 10, hoverRadius: 5 } },
                    scales: {
                        xAxes: [{
                            display: false,
                            ticks: { display: false },
                            gridLines: { display: false }
                        }],
                        yAxes: [{
                            display: true,
                            ticks: {
                                display: true,
                                beginAtZero: true,
                                userCallback: function(label, index, labels) {
                                    if(Math.floor(label) === label) return label;
                                }
                            },
                            gridLines: { display: true }
                        }]
                    },
                    layout: {
                        padding: { top: 15, left: 15, right: 15, bottom: 15 }
                    },
                    tooltips: {
                        callbacks: {
                            label: function(tooltipItem, data) {
                                var dataType = data.datasets[tooltipItem.datasetIndex].dataType || "";
                                var label = tooltipItem.yLabel;
                                if(dataType == "hashrate") label = getReadableHashRateString(tooltipItem.yLabel)+"/s";
                                else if(dataType == "payments") label = getReadableCoins(tooltipItem.yLabel);
                                return " " + label;
                            }
                        }
                    }
                }
            };
            switch(graphType) {
            case "hashes":
                chartConfig.type = "bar";
                chartConfig.data.labels = graphData[graphType].names.slice(-24)
                chartConfig.data.datasets[0].data = graphData[graphType].values.slice(-24)
                break;
            case "payments":
                chartConfig.type = "bar";
                break;
            case "hashrate":
                chartConfig.options.scales.yAxes[0].ticks.userCallback = function(label, index, labels) {
                    if(Math.floor(label) === label) return getReadableHashRateString(label)+"/s";
                }
                break;
            }

            if(chartsObj.hasOwnProperty(graphType) && chartsObj[graphType] != null) {
                chartsObj[graphType].data = chartConfig.data;
                chartsObj[graphType].update();
            } else {
                chartsObj[graphType] = new Chart(ctx, chartConfig);
                $chart.closest(".userChart").show();
            }
        }
    }
}

// Get chart data
function getGraphData(rawData, fixValueToCoins=false) {
    var graphData = {
        names: [],
        values: []
    };

    if(rawData) {
        for (var i = 0, xy; xy = rawData[i]; i++) {
            graphData.names.push(new Date(xy[0]*1000).toLocaleString());
            if(fixValueToCoins) {
                graphData.values.push((xy[1] / 10000).toFixed(4));
            } else {
                graphData.values.push(xy[1]);
            }
        }
    }

    return graphData;
}

/**
 * Workers report
 **/

// Get worker row id
function getWorkerRowId(workerName) {
    var id = btoa(workerName);
    id = id.replace(/=/, "");
    return id;
}

// Get worker row element
function getWorkerRowElement(worker, jsonString) {
    var row = document.createElement("tr");
    row.setAttribute("data-json", jsonString);
    row.setAttribute("data-name", worker.name);
    row.setAttribute("id", "workerRow_" + getWorkerRowId(worker.name));

    row.innerHTML = getWorkerCells(worker);

    return row;
}

// Get worker cells
function getWorkerCells(worker) {
    var hashrate = worker.hashrate ? worker.hashrate : 0;
    var hashrate1h = worker.hashrate_1h || 0;
    var hashrate6h = worker.hashrate_6h || 0;
    var hashrate24h = worker.hashrate_24h || 0;
    var lastShare = worker.lastShare ? worker.lastShare : 0;
    var hashes = (worker.hashes || 0).toString();
    var status = (hashrate <= 0) ? "error" : "ok";

    return '<td class="col1" data-sort="'+status+'"><i class="fa fa-'+(status == 'ok' ? 'check status-ok' : 'times status-error')+'"></i></td>' +
           '<td class="col2" data-sort="'+(worker.name != 'undefined' ? worker.name : '')+'">'+(worker.name != 'undefined' ? worker.name : '<em>Undefined</em>')+'</td>' +
           '<td class="col3" data-sort="'+hashrate+'">'+getReadableHashRateString(hashrate)+'/s</td>' +
           '<td class="col4 avghr" data-sort="'+hashrate1h+'">'+getReadableHashRateString(hashrate1h)+'/s</td>' +
           '<td class="col5 avghr" data-sort="'+hashrate6h+'">'+getReadableHashRateString(hashrate6h)+'/s</td>' +
           '<td class="col6 avghr" data-sort="'+hashrate24h+'">'+getReadableHashRateString(hashrate24h)+'/s</td>' +
           '<td class="col7" data-sort="'+lastShare+'">'+(lastShare ? $.timeago(new Date(parseInt(lastShare) * 1000).toISOString()) : 'Never')+'</td>' +
           '<td class="col8" data-sort="'+hashes+'">'+hashes+'</td>';
}

// Handle sort on workers table
$("#workersReport th.sort").on("click", sortTable);

// Sort workers
function sortWorkers(a, b) {
    var aName = a.name.toLowerCase();
    var bName = b.name.toLowerCase();
    return ((aName < bName) ? -1 : ((aName > bName) ? 1 : 0));
}

// Render workers list
function renderWorkers(workersData) {
    workersData = workersData.sort(sortWorkers);

    var $workersRows = $("#workersReport_rows");

    for (var i = 0; i < workersData.length; i++) {
        var existingRow = document.getElementById("workerRow_" + getWorkerRowId(workersData[i].name));
        if(!existingRow) {
            $workersRows.empty();
            break;
        }
    }

    var have_avg_hr = false;

    for (var i = 0; i < workersData.length; i++) {
        var worker = workersData[i];
	if(Date.now()/1000 - parseInt(worker.lastShare) > 2 * 86400) continue;
        if(!have_avg_hr && "hashrate_1h" in worker) have_avg_hr = true;
        var workerJson = JSON.stringify(worker);
        var existingRow = document.getElementById("workerRow_" + getWorkerRowId(worker.name));
        if(existingRow && existingRow.getAttribute("data-json") !== workerJson) {
            $(existingRow).replaceWith(getWorkerRowElement(worker, workerJson));
        }
        else if(!existingRow) {
            var workerElement = getWorkerRowElement(worker, workerJson);
            $workersRows.append(workerElement);
        }
    }

    if(!have_avg_hr) $("#workersReport .avghr").hide();
    else $("#workersReport .avghr").show();
}


/**
 * Shares Table
 **/
// Get payment row element
function getShareRowElement(share, jsonString) {
    var row = document.createElement("tr");
    row.setAttribute("data-json", jsonString);
    row.setAttribute("data-time", share.time);
    row.setAttribute("id", "shareRow" + share.time);

    row.innerHTML = getShareCells(share);

    return row;
}

// Get share cells
function getShareCells(share) {
    return '<td class="col1">' + formatDate(share.time) + '</td>' +
           '<td class="col2">' + share.hashes + '</td>' +
           '<td class="col3">' + share.shares + '</td>' +
           '<td class="col4">' + share.invalid + '</td>';
}

function renderShares(data) {
    if(!data || data.length == 0) return;
    var $sharesRows = $("#sharesReport_rows");

    var shares = {};

    for(var i = 0; i < data.length; i++) {
        var hour = Math.round(Math.floor(data[i][0] / 3600) * 3600);
        if(!shares.hasOwnProperty(hour)) {
            shares[hour] = {"hashes": 0, "shares": 0, "invalid": 0};
        }
        shares[hour]["hashes"] += data[i][1];
        shares[hour]["shares"] += data[i][2];
        shares[hour]["invalid"] += data[i][3] || 0;
    }

    for(var hour = Math.round(Math.floor(data[0][0] / 3600) * 3600); hour < Date.now() / 1000; hour += 3600) {

        if(shares.hasOwnProperty(hour)) {
            var share = shares[hour];
        } else {
            var share = {"hashes": 0, "shares": 0, "invalid": 0};
        }
        share.time = hour;

        var shareJson = JSON.stringify(share);
        var shareElement = getShareRowElement(share, shareJson);

        var existingRow = document.getElementById("shareRow" + share.time);
        if(existingRow && existingRow.getAttribute("data-json") !== shareJson) {
            $(existingRow).replaceWith(shareElement);
        } else if(!existingRow) {
            $sharesRows.prepend(shareElement);
        }
    }
}

/**
 * Payments report
 **/

// Parse payment data
function parsePayment(time, serializedPayment) {
    var parts = serializedPayment.split(":");
    return {
        time: parseInt(time),
        hash: parts[0],
        amount: parts[1],
        fee: parts[2]
    };
}

// Get payment row element
function getPaymentRowElement(payment, jsonString) {
    var row = document.createElement("tr");
    row.setAttribute("data-json", jsonString);
    row.setAttribute("data-time", payment.time);
    row.setAttribute("id", "paymentRow" + payment.time);

    row.innerHTML = getPaymentCells(payment);

    return row;
}

// Get payment cells
function getPaymentCells(payment) {
    return '<td class="col1">' + formatDate(payment.time) + '</td>' +
           '<td class="col2">' + formatPaymentLink(payment.hash) + '</td>' +
           '<td class="col3">' + getReadableCoins(payment.amount, true) + '</td>' +
           '<td class="col4">' + getReadableCoins(payment.fee, true) + '</td>';
}

// Get summary row element
function getSummaryRowElement(summary, jsonString) {
    var row = document.createElement("tr");
    row.setAttribute("data-json", jsonString);
    row.setAttribute("data-date", summary.date);
    row.setAttribute("id", "summaryRow" + summary.date);
    row.setAttribute("class", "summary");

    row.innerHTML = getSummaryCells(summary);

    return row;
}

// Get summary cells
function getSummaryCells(summary) {
    var text = getTranslation("paymentSummaryMulti") ? getTranslation("paymentSummaryMulti") : "On %DATE% you have received %AMOUNT% in %COUNT% payments";
    if(summary.count <= 1) text = getTranslation("paymentSummarySingle") ? getTranslation("paymentSummarySingle") : "On %DATE% you have received %AMOUNT%";
    text = text.replace(/%DATE%/g, summary.date);
    text = text.replace(/%COUNT%/g, summary.count);
    text = text.replace(/%AMOUNT%/g, getReadableCoins(summary.amount, true));
    return '<td colspan="4">' + text + '</td>';
}

// Render payments
function renderPayments(paymentsResults) {
    var $paymentsRows = $("#paymentsReport_rows");
    var lastPaymentDate = null;
    var summaryData = { date: null, time: null, count: 0, amount: 0 };
    for (var i = 0; i < paymentsResults.length; i += 2) {
        var payment = parsePayment(paymentsResults[i + 1], paymentsResults[i]);
        var paymentJson = JSON.stringify(payment);
        var paymentElement = getPaymentRowElement(payment, paymentJson);

        var paymentDate = new Date(parseInt(payment.time) * 1000).toLocaleDateString();
        if(!lastPaymentDate || lastPaymentDate && paymentDate != lastPaymentDate) {
            summaryData = { date: paymentDate, time: payment.time, count: 0, amount: 0 };
        }

        var existingRow = document.getElementById("paymentRow" + payment.time);
        if(existingRow && existingRow.getAttribute("data-json") !== paymentJson) {
            $(existingRow).replaceWith(getPaymentRowElement(payment, paymentJson));
        }
        else if(!existingRow) {
            var inserted = false;
            var rows = $paymentsRows.children().get();
            for (var f = 0; f < rows.length; f++) {
                var pTime = parseInt(rows[f].getAttribute("data-time"));
                if(pTime && pTime < payment.time) {
                    inserted = true;
                    $(rows[f]).before(paymentElement);
                    break;
                }
            }
            if(!inserted) {
                $paymentsRows.append(paymentElement);
            }
        }

        summaryData.count ++;
        summaryData.amount += parseInt(payment.amount);

        var summaryJson = JSON.stringify(summaryData);
        var summaryElement = getSummaryRowElement(summaryData, summaryJson);

        var existingSummary = document.getElementById("summaryRow" + summaryData.date);
        if(existingSummary && existingSummary.getAttribute("data-json") !== summaryJson) {
            $(existingSummary).replaceWith(summaryElement);
        }
        else if(!existingSummary) {
            var inserted = false;
            var rows = $paymentsRows.children().get();
            for (var f = 0; f < rows.length; f++) {
                var pTime = parseInt(rows[f].getAttribute("data-time"));
                if(pTime && pTime === summaryData.time) {
                    inserted = true;
                    $(rows[f]).before(summaryElement);
                    break;
                }
            }
            if(!inserted) {
                $paymentsRows.append(summaryElement);
            }
        }
        lastPaymentDate = paymentDate;
    }
}

// Load more payments button
var xhrGetPayments;
$("#loadMorePayments").click(function() {
    if(xhrGetPayments) xhrGetPayments.abort();
    xhrGetPayments = $.ajax({
        url: api + "/get_payments",
        data: {
            time: $("#paymentsReport_rows").children().last().data("time"),
            address: address
        },
        dataType: "json",
        cache: "false",
        success: function(data) {
            renderPayments(data);
        }
    });
});

/**
 * Pasa Payments report
 **/

// Parse payment data
function parsePasaPayment(time, serializedPayment) {
    var parts = serializedPayment.split(":");
    return {
        time: parseInt(time),
        hash: parts[0],
        fee: parts[1],
        account: parts[2]
    };
}

// Get payment row element
function getPasaPaymentRowElement(payment, jsonString) {
    var row = document.createElement("tr");
    row.setAttribute("data-json", jsonString);
    row.setAttribute("data-time", payment.time);
    row.setAttribute("id", "pasaPaymentRow" + payment.hash);

    row.innerHTML = getPasaPaymentCells(payment);

    return row;
}

// Get payment cells
function getPasaPaymentCells(payment) {
    return '<td class="col1">' + formatDate(payment.time) + '</td>' +
           '<td class="col2">' + formatPaymentLink(payment.hash) + '</td>' +
           '<td class="col3">' + formatExternalAccountLink(payment.account) + '</td>' +
           '<td class="col4">' + getReadableCoins(payment.fee, true) + '</td>';
}

// Render pasa payments
function renderPasaPayments(paymentsResults) {
    var $paymentsRows = $("#pasaPaymentsReport_rows");
    for (var i = 0; i < paymentsResults.length; i += 2) {
        var payment = parsePasaPayment(paymentsResults[i + 1], paymentsResults[i]);
        var paymentJson = JSON.stringify(payment);
        var paymentElement = getPasaPaymentRowElement(payment, paymentJson);

        var paymentDate = new Date(parseInt(payment.time) * 1000).toLocaleDateString();

        var existingRow = document.getElementById("pasaPaymentRow" + payment.hash);
        if(existingRow && existingRow.getAttribute("data-json") !== paymentJson) {
            $(existingRow).replaceWith(getPasaPaymentRowElement(payment, paymentJson));
        }
        else if(!existingRow) {
            var inserted = false;
            var rows = $paymentsRows.children().get();
            for (var f = 0; f < rows.length; f++) {
                var pTime = parseInt(rows[f].getAttribute("data-time"));
                if(pTime && pTime < payment.time) {
                    inserted = true;
                    $(rows[f]).before(paymentElement);
                    break;
                }
            }
            if(!inserted) {
                $paymentsRows.append(paymentElement);
            }
        }
    }
}

// Load more payments button
var xhrGetPasaPayments;
$("#loadMorePasaPayments").click(function() {
    if(xhrGetPayments) xhrGetPayments.abort();
    xhrGetPayments = $.ajax({
        url: api + "/get_pasa_payments",
        data: {
            time: $("#pasaPaymentsReport_rows").children().last().data("time"),
            address: address
        },
        dataType: "json",
        cache: "false",
        success: function(data) {
            renderPasaPayments(data);
        }
    });
});

// save settings button
var xhrSaveSettings;
$("#saveSettings").click(function() {
    if(xhrSaveSettings) xhrSaveSettings.abort();
    xhrSaveSettings = $.ajax({
        url: api + "/set_miner_settings",
        data: $("#userSettings").serialize(),
        dataType: "json",
        cache: "false",
        success: function(data) {
            if(data.status == "done") {
                $("#settingsMessage").html('<i class="fa fa-exclamation-triangle"></i> Settings saved!');
                $("#settingsMessage").css("color", "#0b6623");
                fetchAddressSettings();
            } else {
                $("#settingsMessage").html('<i class="fa fa-exclamation-triangle"></i> '+data.status);
                $("#settingsMessage").css("color", "red");
            }
        }
    });
});

</script>
